---
title: "Sex Specific Contributions Exploratory Analysis"
output: 
  html_document: 
    keep_md: true
date: "2024-02-29"
---
### Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(naniar)
library(janitor)
library(shiny)
```

```{r}
dataset <- read_delim("data/Sex_specific_contribution.csv", delim=";") %>% clean_names()
```


```{r}
dataset <- dataset %>% 
  separate(species, into= c("genus", "species"), sep = "_")
head(dataset)
```

```{r}
large_genuses_data <- dataset %>% 
  group_by(genus) %>% 
  summarize(n_species=n()) %>% 
  arrange(desc(n_species)) %>% 
  slice_head(n=35)
large_genuses <- large_genuses_data$genus
```





#### App structure
Plot distribution of nest_builder (sex): dropdown of group by all, or by each of the variables

Plot distribution of nest_builder (sex) against continuous variables: dropdown of continuous variable type, dropdown of plot type

Free exploration section!
1-categorical plot, dropdown for the 1 categorical, dropdown for coloring/grouping
1-categorical 1-continuous plot, dropdowns for each variable
2-continuous plot, dropdowns for each variable, dropdown for coloring

#### Bigger badder app

```{r}
ui <- fluidPage(
  titlePanel("Sex Specific Nest Building - Plotting"),
  
  sidebarLayout(
    sidebarPanel(
      selectInput("master_input", "Select Plot Type",
                  choices = c("Plot distribution of nest_builder (sex)", 
                              "Plot distribution of nest_builder (sex) against continuous variables",
                              "Trends in breeding season length (and other continuous variables)",
                              "Differences between species of a genus"))
    ),
    
    mainPanel(
      uiOutput("additional_inputs"),
      plotOutput("plot")
    )
  )
)


# define a server for the Shiny app
server <- function(input, output, session) {
  
  # this stops the app upon closing
  session$onSessionEnded(stopApp)
  
  #changes UI by master_input
  output$additional_inputs <- renderUI({
    plot_type <- input$master_input
    
    if (plot_type == "Plot distribution of nest_builder (sex)") {
      tagList(
        selectInput("fill_var", "Select fill variable:", choices=c("nest_site", "nest_structure", "incubating_sex"), selected = "nest_site")
      )
    } else if (plot_type == "Plot distribution of nest_builder (sex) against continuous variables") {
      tagList(
        selectInput("y_var", "Select y variable:", choices=c("clutch_size_mean", "length_breeding", "latitude_mean"), selected = "clutch_size_mean")
      )
    } else if (plot_type == "Trends in breeding season length (and other continuous variables)") {
      tagList(
        selectInput("y_var", "Select y variable:", choices=c("clutch_size_mean", "latitude_mean"), selected = "latitude_mean")
      )
    } else if (plot_type == "Differences between species of a genus") {
      tagList(
        selectInput("y_var", "Select y variable:", choices=c("nest_builder", "nest_site", "nest_structure", "incubating_sex", "clutch_size_mean", "length_breeding", "latitude_mean"), selected = "nest_builder")
      )
    }
  })
  # fill in the spot we created for a plot
  output$plot <- renderPlot({
    plot_type <- input$master_input
    if (plot_type == "Plot distribution of nest_builder (sex)") {
      dataset %>%
        ggplot(aes_string(x="nest_builder", fill=input$fill_var))+
        geom_bar(position = "dodge") +
        theme(axis.text.x = element_text(angle=50, hjust=1)) +
        labs(x="Sex", 
         y="Count", fill="Fill by") +
        scale_fill_brewer(palette="YlGnBu")
    } else if (plot_type == "Plot distribution of nest_builder (sex) against continuous variables") {
      dataset %>%
        ggplot(aes_string(x="nest_builder", y=input$y_var, fill="nest_builder"))+
        geom_boxplot() +
        theme(axis.text.x = element_text(angle=50, hjust=1)) +
        labs(x="Sex", 
         y=input$y_var) +
        scale_fill_brewer(palette="YlGnBu")
    } else if (plot_type == "Trends in breeding season length (and other continuous variables)") {
      dataset %>%
        ggplot(aes_string(x="length_breeding", y=input$y_var))+
        geom_point() +
        geom_smooth(method = "lm", se = FALSE)+ #, aes(group = nest_structure))+
        theme(axis.text.x = element_text(angle=50, hjust=1)) +
        labs(x="Length of Breeding Season", 
         y=input$y_var) +
        scale_fill_brewer(palette="YlGnBu")
    } else if (plot_type == "Differences between species of a genus") {
      genus_filtered_dataset <- filter(dataset, genus %in% large_genuses)
      p <- ggplot(genus_filtered_dataset, aes_string(x="genus", y=input$y_var))+
          theme(axis.text.x = element_text(angle=50, hjust=1)) +
          labs(x="Genus", y=input$y_var)
      if (input$y_var %in% c("nest_builder", "nest_site", "nest_structure", "incubating_sex")) {
        p <- p+geom_count(color="#7fcdbb")
      } else if (input$y_var %in% c("clutch_size_mean", "length_breeding", "latitude_mean")) {
        p <- p+geom_boxplot(fill="#7fcdbb")
      }
      p  
    }
  })
  }

shinyApp(ui, server)
```
genus_filtered_dataset <- filter(dataset, genus == input$genus)